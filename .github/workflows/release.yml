name: Publish Release

permissions:
  contents: write

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  # Build Linux binaries and packages
  build-linux:
    name: Build Linux - ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: x64
            target: x86_64-unknown-linux-gnu
            triplet: x86_64
          - arch: arm64
            target: aarch64-unknown-linux-gnu
            triplet: aarch64

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Build binary
        run: cross build --release --target ${{ matrix.target }}

      - name: Copy binary
        run: |
          mkdir -p release
          cp target/${{ matrix.target }}/release/UDTool release/UDTool-linux-${{ matrix.arch }}

      - name: Install build tools for DEB/RPM
        run: |
          sudo apt-get update
          cargo install cargo-deb cargo-rpm
          sudo apt-get install -y ruby-dev > /dev/null 2>&1 || true
          sudo gem install fpm > /dev/null 2>&1 || true
          
          # Install cross-compilation toolchain for ARM64
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            aarch64-linux-gnu-gcc \
            aarch64-linux-gnu-g++ \
            libssl-dev > /dev/null 2>&1 || true

      - name: Build DEB package
        run: |
          mkdir -p release
          cargo deb --target ${{ matrix.target }} --output release/
        env:
          OPENSSL_DIR: /usr
          OPENSSL_LIB_DIR: /usr/lib/x86_64-linux-gnu
          OPENSSL_INCLUDE_DIR: /usr/include

      - name: Build RPM package
        run: |
          mkdir -p release
          cargo rpm build --target ${{ matrix.target }} --output release/ 2>/dev/null || true
          # Fallback: Create RPM manually if cargo-rpm fails
          if [ ! -f release/*.rpm ]; then
            mkdir -p rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
            mkdir -p rpmroot/usr/local/bin
            cp target/${{ matrix.target }}/release/UDTool rpmroot/usr/local/bin/
            fpm -s dir -t rpm -n udtool -v 1.0.0 \
              -C rpmroot -o release/ \
              --maintainer "Ari Cummings <ari@aricummings.com>" \
              --description "Universal Data Tool - Manage files on remote server" 2>/dev/null || true
          fi
        env:
          OPENSSL_DIR: /usr
          OPENSSL_LIB_DIR: /usr/lib/x86_64-linux-gnu
          OPENSSL_INCLUDE_DIR: /usr/include

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.arch }}
          path: release/*

  # Build macOS binaries and PKG installers
  build-macos:
    name: Build macOS
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin,aarch64-apple-darwin

      - name: Build x64 binary
        run: cargo build --release --target x86_64-apple-darwin

      - name: Build ARM64 binary
        run: cargo build --release --target aarch64-apple-darwin

      - name: Copy binaries
        run: |
          mkdir -p release
          cp target/x86_64-apple-darwin/release/UDTool release/UDTool-macos-x64
          cp target/aarch64-apple-darwin/release/UDTool release/UDTool-macos-arm64

      - name: Create universal binary
        run: |
          lipo -create \
            target/x86_64-apple-darwin/release/UDTool \
            target/aarch64-apple-darwin/release/UDTool \
            -output release/UDTool-macos-universal

      - name: Build PKG installer
        run: |
          # Extract version from tag or use fallback
          VERSION="${{ github.ref_name }}"
          if [[ "$VERSION" == "master" ]] || [[ "$VERSION" == "main" ]]; then
            VERSION="1.0.0"
          fi
          VERSION=${VERSION#v}
          
          STAGING_DIR="pkg_staging"
          rm -rf "$STAGING_DIR"
          mkdir -p "$STAGING_DIR/usr/local/bin"
          
          cp release/UDTool-macos-universal "$STAGING_DIR/usr/local/bin/UDTool"
          chmod 755 "$STAGING_DIR/usr/local/bin/UDTool"
          
          SCRIPTS_DIR=$(mktemp -d)
          cat > "$SCRIPTS_DIR/postinstall" << 'POSTINSTALL_EOF'
          #!/bin/bash
          echo "UDTool installed successfully to /usr/local/bin/UDTool"
          POSTINSTALL_EOF
          chmod +x "$SCRIPTS_DIR/postinstall"
          
          pkgbuild --root "$STAGING_DIR" \
            --scripts "$SCRIPTS_DIR" \
            --identifier "com.aricummings.udtool" \
            --version "$VERSION" \
            --install-location "/" \
            "release/UDTool-${VERSION}.pkg"
          
          rm -rf "$STAGING_DIR" "$SCRIPTS_DIR"

      - name: Generate checksums
        run: |
          cd release
          sha256sum * > SHA256SUMS
          cd ..

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos
          path: release/*

  # Build Windows executables and MSI installers
  build-windows:
    name: Build Windows - ${{ matrix.arch }}
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - arch: x64
            target: x86_64-pc-windows-msvc
          - arch: arm64
            target: aarch64-pc-windows-msvc

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build binary
        run: cargo build --release --target ${{ matrix.target }}

      - name: Copy binary
        run: |
          New-Item -ItemType Directory -Path release -Force
          Copy-Item target/${{ matrix.target }}/release/UDTool.exe release/UDTool-windows-${{ matrix.arch }}.exe

      - name: Build MSI installer (WiX)
        run: |
          # Download and install WiX v6 CLI MSI
          $wixMsiUrl = "https://github.com/wixtoolset/wix/releases/download/v6.0.2/wix-cli-x64.msi"
          $wixToolsUrl = "https://github.com/wixtoolset/wix/releases/download/v6.0.2/WixAdditionalTools.exe"
          
          Write-Host "Downloading WiX CLI..."
          Invoke-WebRequest -Uri $wixMsiUrl -OutFile wix-cli.msi -UseBasicParsing
          
          Write-Host "Installing WiX CLI..."
          msiexec /i wix-cli.msi /quiet /norestart
          
          Write-Host "Downloading WiX Additional Tools..."
          Invoke-WebRequest -Uri $wixToolsUrl -OutFile WixAdditionalTools.exe -UseBasicParsing
          
          Write-Host "Installing WiX Additional Tools..."
          .\WixAdditionalTools.exe /quiet /norestart
          
          # Add WiX to PATH
          $env:PATH = "C:\Program Files (x86)\WiX Toolset v6.0\bin;$env:PATH"
          
          # Extract version
          $version = "${{ github.ref_name }}" -replace 'v', ''
          if ($version -eq "master" -or $version -eq "main") {
            $version = "1.0.0"
          }
          
          # Create release directory
          New-Item -ItemType Directory -Path release -Force -ErrorAction SilentlyContinue | Out-Null
          
          # Build MSI
          wix build wix\main.wxs `
            -d Version="$version" `
            -d CargoTargetBinDir=target\${{ matrix.target }}\release `
            -d PlatformArch=${{ matrix.arch }} `
            -ext WixToolset.UI.wixext `
            -o release\UDTool-$version-${{ matrix.arch }}.msi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ matrix.arch }}
          path: release/*

  # Create GitHub release with all artifacts
  create-release:
    name: Create Release
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Organize artifacts
        run: |
          mkdir -p release-files
          find all-artifacts -type f ! -name ".*" -exec cp {} release-files/ \;
          cd release-files
          ls -lah

      - name: Generate checksums for all files
        run: |
          cd release-files
          sha256sum * > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: release-files/*
          tag_name: ${{ github.ref_name }}
          draft: false
          prerelease: false
          body: |
            # UDTool ${{ github.ref_name }}
            
            ## Downloads
            
            ### Linux
            - **Executables**: UDTool-linux-x64, UDTool-linux-arm64
            - **Debian packages**: UDTool-linux-x64.deb, UDTool-linux-arm64.deb
            - **RPM packages**: UDTool-linux-x64.rpm, UDTool-linux-arm64.rpm
            
            ### macOS
            - **Executables**: UDTool-macos-x64, UDTool-macos-arm64, UDTool-macos-universal
            - **Installer**: UDTool-1.0.0.pkg (or version-specific)
            
            ### Windows
            - **Executables**: UDTool-windows-x64.exe, UDTool-windows-arm64.exe
            - **Installers**: UDTool-1.0.0-x64.msi, UDTool-1.0.0-arm64.msi (or version-specific)
            
            ## Installation
            
            **Windows**: Download the .msi file and run
            **macOS**: Download the .pkg file and run
            **Linux**: Download the executable or DEB/RPM package
            
            ## Verify Downloads
            ```bash
            sha256sum -c SHA256SUMS.txt
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
