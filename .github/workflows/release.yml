name: Publish Release

permissions:
  contents: write

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  # Build Linux binaries and packages
  build-linux:
    name: Build Linux - ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: x64
            target: x86_64-unknown-linux-gnu
            deb_arch: amd64
            rpm_arch: x86_64
          - arch: arm64
            target: aarch64-unknown-linux-gnu
            deb_arch: arm64
            rpm_arch: aarch64

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby-dev
          sudo gem install fpm

      - name: Build binary with cross
        run: |
          cargo install cross --git https://github.com/cross-rs/cross
          cross build --release --target ${{ matrix.target }}

      - name: Copy binary
        run: |
          mkdir -p release
          cp target/${{ matrix.target }}/release/UDTool release/UDTool-linux-${{ matrix.arch }}

      - name: Extract version
        id: version
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION=${VERSION#v}
          if [[ "$VERSION" == "master" ]] || [[ "$VERSION" == "main" ]]; then
            VERSION="1.0.0"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build DEB package
        run: |
          mkdir -p deb_build/usr/local/bin
          cp target/${{ matrix.target }}/release/UDTool deb_build/usr/local/bin/
          
          fpm -s dir \
            -t deb \
            -n udtool \
            -v ${{ steps.version.outputs.version }} \
            -a ${{ matrix.deb_arch }} \
            --maintainer "Ari Cummings <ari@aricummings.com>" \
            --description "Universal Data Tool - Manage files on remote server" \
            -C deb_build \
            -p release/udtool_${{ steps.version.outputs.version }}-1_${{ matrix.deb_arch }}.deb \
            usr/local/bin/UDTool

      - name: Build RPM package
        run: |
          mkdir -p rpm_build/usr/local/bin
          cp target/${{ matrix.target }}/release/UDTool rpm_build/usr/local/bin/
          
          fpm -s dir \
            -t rpm \
            -n udtool \
            -v ${{ steps.version.outputs.version }} \
            -a ${{ matrix.rpm_arch }} \
            --maintainer "Ari Cummings <ari@aricummings.com>" \
            --description "Universal Data Tool - Manage files on remote server" \
            --rpm-os linux \
            -C rpm_build \
            -p release/udtool-${{ steps.version.outputs.version }}-1.${{ matrix.rpm_arch }}.rpm \
            usr/local/bin/UDTool

      - name: Clean up empty files
        run: |
          # Remove any empty files (size 0) to avoid upload errors
          find release -type f -size 0 -delete || true

      - name: List artifacts
        run: |
          echo "Created artifacts:"
          ls -lah release/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.arch }}
          path: release/*

  # Build macOS binaries and PKG installers
  build-macos:
    name: Build macOS
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin,aarch64-apple-darwin

      - name: Build x64 binary
        run: cargo build --release --target x86_64-apple-darwin

      - name: Build ARM64 binary
        run: cargo build --release --target aarch64-apple-darwin

      - name: Copy binaries
        run: |
          mkdir -p release
          cp target/x86_64-apple-darwin/release/UDTool release/UDTool-macos-x64
          cp target/aarch64-apple-darwin/release/UDTool release/UDTool-macos-arm64

      - name: Create universal binary
        run: |
          lipo -create \
            target/x86_64-apple-darwin/release/UDTool \
            target/aarch64-apple-darwin/release/UDTool \
            -output release/UDTool-macos-universal

      - name: Extract version
        id: version
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION=${VERSION#v}
          if [[ "$VERSION" == "master" ]] || [[ "$VERSION" == "main" ]]; then
            VERSION="1.0.0"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build PKG installer
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          STAGING_DIR="pkg_staging"
          rm -rf "$STAGING_DIR"
          mkdir -p "$STAGING_DIR/usr/local/bin"
          
          cp release/UDTool-macos-universal "$STAGING_DIR/usr/local/bin/UDTool"
          chmod 755 "$STAGING_DIR/usr/local/bin/UDTool"
          
          SCRIPTS_DIR=$(mktemp -d)
          cat > "$SCRIPTS_DIR/postinstall" << 'POSTINSTALL_EOF'
          #!/bin/bash
          echo "UDTool installed successfully to /usr/local/bin/UDTool"
          POSTINSTALL_EOF
          chmod +x "$SCRIPTS_DIR/postinstall"
          
          pkgbuild --root "$STAGING_DIR" \
            --scripts "$SCRIPTS_DIR" \
            --identifier "com.aricummings.udtool" \
            --version "$VERSION" \
            --install-location "/" \
            "release/UDTool-${VERSION}.pkg"
          
          rm -rf "$STAGING_DIR" "$SCRIPTS_DIR"

      - name: Generate checksums
        run: |
          cd release
          sha256sum * > SHA256SUMS
          cd ..

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos
          path: release/*

  # Build Windows executables and MSI installers
  build-windows:
    name: Build Windows - ${{ matrix.arch }}
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - arch: x64
            target: x86_64-pc-windows-msvc
          - arch: arm64
            target: aarch64-pc-windows-msvc

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build binary
        run: cargo build --release --target ${{ matrix.target }}

      - name: Copy binary
        run: |
          New-Item -ItemType Directory -Path release -Force
          Copy-Item target/${{ matrix.target }}/release/UDTool.exe release/UDTool-windows-${{ matrix.arch }}.exe

      - name: Extract version
        id: version
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}" -replace 'v', ''
          if ($version -eq "master" -or $version -eq "main") {
            $version = "1.0.0"
          }
          Add-Content -Path $env:GITHUB_OUTPUT -Value "version=$version"

      - name: Build MSI installer (WiX)
        run: |
          # Download and install WiX v6 CLI MSI
          $wixMsiUrl = "https://github.com/wixtoolset/wix/releases/download/v6.0.2/wix-cli-x64.msi"
          $wixToolsUrl = "https://github.com/wixtoolset/wix/releases/download/v6.0.2/WixAdditionalTools.exe"
          
          Write-Host "Downloading WiX CLI..."
          Invoke-WebRequest -Uri $wixMsiUrl -OutFile wix-cli.msi -UseBasicParsing
          
          Write-Host "Installing WiX CLI..."
          msiexec /i wix-cli.msi /quiet /norestart
          
          Write-Host "Downloading WiX Additional Tools..."
          Invoke-WebRequest -Uri $wixToolsUrl -OutFile WixAdditionalTools.exe -UseBasicParsing
          
          Write-Host "Installing WiX Additional Tools..."
          .\WixAdditionalTools.exe /quiet /norestart
          
          # Wait for installation to complete
          Start-Sleep -Seconds 5
          
          # Find WiX installation - check multiple possible locations
          $possiblePaths = @(
            "C:\Program Files (x86)\WiX Toolset v6.0\bin\wix.exe",
            "C:\Program Files\WiX Toolset v6.0\bin\wix.exe",
            "C:\Program Files (x86)\WiX Toolset\bin\wix.exe",
            "C:\Program Files\WiX Toolset\bin\wix.exe"
          )
          
          $wixPath = $null
          foreach ($path in $possiblePaths) {
            if (Test-Path $path) {
              $wixPath = $path
              Write-Host "Found WiX at: $wixPath"
              break
            }
          }
          
          # Also try to find it via where command
          if (-not $wixPath) {
            try {
              $wixPath = (where.exe wix.exe 2>$null | Select-Object -First 1)
              if ($wixPath) {
                Write-Host "Found WiX via where: $wixPath"
              }
            } catch {
              Write-Host "where.exe command failed"
            }
          }
          
          if (-not $wixPath -or -not (Test-Path $wixPath)) {
            Write-Host "ERROR: WiX not found in any expected location"
            Write-Host "Checking installed programs..."
            Get-ChildItem "C:\Program Files" -Filter "WiX*" -Directory -ErrorAction SilentlyContinue | ForEach-Object {
              Write-Host "Found directory: $_"
              Get-ChildItem $_.FullPath -Recurse -Filter "wix.exe" -ErrorAction SilentlyContinue | ForEach-Object {
                Write-Host "  Found wix.exe at: $($_.FullName)"
              }
            }
            exit 1
          }
          
          Write-Host "Using WiX at: $wixPath"
          
          # Use version from previous step
          $version = "${{ steps.version.outputs.version }}"
          
          # Create release directory
          New-Item -ItemType Directory -Path release -Force -ErrorAction SilentlyContinue | Out-Null
          
          # Build MSI using found wix path
          & "$wixPath" build wix\main.wxs `
            -d Version="$version" `
            -d CargoTargetBinDir=target\${{ matrix.target }}\release `
            -d PlatformArch=${{ matrix.arch }} `
            -ext WixToolset.UI.wixext `
            -o release\UDTool-$version-${{ matrix.arch }}.msi

      - name: Clean up debug files
        run: |
          # Remove .wixpdb files (debug symbols, not needed for release)
          Remove-Item release\*.wixpdb -Force -ErrorAction SilentlyContinue

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ matrix.arch }}
          path: release/*

  # Create GitHub release with all artifacts
  create-release:
    name: Create Release
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Organize artifacts
        run: |
          mkdir -p release-files
          find all-artifacts -type f ! -name ".*" -exec cp {} release-files/ \;
          
          # Remove empty files (size 0) to avoid GitHub upload errors
          find release-files -type f -size 0 -delete || true
          
          cd release-files
          ls -lah

      - name: Generate checksums for all files
        run: |
          cd release-files
          sha256sum * > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: release-files/*
          tag_name: ${{ github.ref_name }}
          draft: false
          prerelease: false
          body: |
            # UDTool ${{ github.ref_name }}
            
            ## Downloads
            
            ### Linux
            - **Executables**: UDTool-linux-x64, UDTool-linux-arm64
            - **Debian packages**: UDTool-linux-x64.deb, UDTool-linux-arm64.deb
            - **RPM packages**: UDTool-linux-x64.rpm, UDTool-linux-arm64.rpm
            
            ### macOS
            - **Executables**: UDTool-macos-x64, UDTool-macos-arm64, UDTool-macos-universal
            - **Installer**: UDTool-1.0.0.pkg (or version-specific)
            
            ### Windows
            - **Executables**: UDTool-windows-x64.exe, UDTool-windows-arm64.exe
            - **Installers**: UDTool-1.0.0-x64.msi, UDTool-1.0.0-arm64.msi (or version-specific)
            
            ## Installation
            
            **Windows**: Download the .msi file and run
            **macOS**: Download the .pkg file and run
            **Linux**: Download the executable or DEB/RPM package
            
            ## Verify Downloads
            ```bash
            sha256sum -c SHA256SUMS.txt
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
